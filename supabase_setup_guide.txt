# Supabase Setup Guide for VastraVerse

## 1. Database Tables Setup

### 1.1 Profiles Table
```sql
-- Create profiles table
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users NOT NULL PRIMARY KEY,
  full_name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
```

### 1.2 Products Table (Example - adjust fields as needed)
```sql
CREATE TABLE public.products (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  price DECIMAL(10,2) NOT NULL,
  image_url TEXT,
  category TEXT,
  stock_quantity INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
```

## 2. Row Level Security (RLS) Policies

### 2.1 Profiles Table Policies
```sql
-- Allow public read access to all profiles (adjust if needed)
CREATE POLICY "Public profiles are viewable by everyone." 
ON public.profiles FOR SELECT 
USING (true);

-- Allow users to update their own profile
CREATE POLICY "Users can update own profile"
ON public.profiles FOR UPDATE
USING (auth.uid() = id);
```

### 2.2 Products Table Policies (Example)
```sql
-- Allow all users to view products
CREATE POLICY "Enable read access for all users" 
ON public.products FOR SELECT 
USING (true);

-- Allow only authenticated users to insert products (admin only in real app)
CREATE POLICY "Enable insert for authenticated users only"
ON public.products FOR INSERT
TO authenticated
WITH CHECK (true);
```

## 3. Database Functions

### 3.1 Auto-update updated_at
```sql
-- Create function to update updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
   NEW.updated_at = NOW();
   RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Add trigger to profiles
CREATE TRIGGER update_profiles_updated_at
BEFORE UPDATE ON public.profiles
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

-- Add trigger to products
CREATE TRIGGER update_products_updated_at
BEFORE UPDATE ON public.products
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### 3.2 Auto-create user profile
```sql
-- Function to handle new user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, avatar_url)
  VALUES (
    NEW.id,
    NEW.raw_user_meta_data->>'full_name',
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger for new user signup
CREATE OR REPLACE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

## 4. Authentication Setup

### 4.1 Enable Auth Providers
1. Go to Supabase Dashboard > Authentication > Providers
2. Enable "Email/Password" provider
3. (Optional) Enable other providers (Google, GitHub, etc.)

### 4.2 Email Templates
1. Go to Authentication > Templates
2. Customize email templates for:
   - Signup Confirmation
   - Password Reset
   - Email Change
   - Magic Link

## 5. Storage Setup

### 5.1 Create Storage Buckets
1. Go to Storage > Create Bucket
2. Create buckets:
   - `avatars` (for user profile pictures)
   - `products` (for product images)

### 5.2 Set Bucket Policies
For each bucket, set appropriate RLS policies:

```sql
-- Example for avatars bucket
CREATE POLICY "Avatar images are publicly accessible"
ON storage.objects FOR SELECT
USING (bucket_id = 'avatars');

CREATE POLICY "Users can upload their own avatar"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'avatars' AND (storage.foldername(name))[1] = auth.uid()::text);
```

## 6. Environment Variables

### 6.1 Frontend (.env)
```
VITE_SUPABASE_URL=your-supabase-project-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

### 6.2 Backend (if applicable)
```
SUPABASE_URL=your-supabase-project-url
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

## 7. CORS Configuration
1. Go to Settings > API
2. Add your frontend domain to "Site URL"
3. Add any additional domains that need access

## 8. Database Extensions (if needed)
```sql
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Enable pg_cron for scheduled tasks (if needed)
CREATE EXTENSION pg_cron;
```

## 9. Testing
1. Test user registration
2. Test login/logout
3. Test profile updates
4. Test any protected routes

## 10. Monitoring
1. Set up logging in Supabase Dashboard
2. Configure alerts for errors
3. Monitor database performance

## Important Notes:
1. Never expose your service role key in the frontend
2. Always use RLS to secure your data
3. Regularly backup your database
4. Monitor your API usage and database performance
5. Keep your Supabase client libraries up to date
